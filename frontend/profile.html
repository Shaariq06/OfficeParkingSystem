<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-50">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Profile - Office Parking System</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="h-full font-sans antialiased text-gray-800">
    <div id="app" class="min-h-full">
      <!-- Navigation Bar -->
      <nav class="bg-gray-800">
        <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
          <div class="flex h-16 items-center justify-between">
            <div class="flex items-center">
              <h1 class="text-xl font-bold text-white">
                Office Parking System
              </h1>
            </div>
            <div class="flex items-center space-x-4">
              <a
                id="admin-link"
                href="admin.html"
                class="hidden text-gray-300 hover:bg-gray-700 hover:text-white rounded-md px-3 py-2 text-sm font-medium"
              >
                Admin
              </a>
              <a
                href="dashboard.html"
                class="text-gray-300 hover:bg-gray-700 hover:text-white rounded-md px-3 py-2 text-sm font-medium"
              >
                Dashboard
              </a>
              <button
                id="logout-btn"
                class="text-gray-300 hover:bg-gray-700 hover:text-white rounded-md px-3 py-2 text-sm font-medium"
              >
                Logout
              </button>
            </div>
          </div>
        </div>
      </nav>

      <!-- Main Content -->
      <main class="py-10">
        <div class="mx-auto max-w-3xl px-4 sm:px-6 lg:px-8">
          <div class="bg-white p-6 shadow rounded-lg">
            <h2 class="text-lg font-medium text-gray-900 mb-4">My Profile</h2>
            <div class="grid grid-cols-1 gap-y-6 sm:grid-cols-2 sm:gap-x-6">
              <div>
                <label class="block text-sm font-medium text-gray-700"
                  >First Name</label
                >
                <p id="first-name" class="mt-1 text-gray-900"></p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700"
                  >Last Name</label
                >
                <p id="last-name" class="mt-1 text-gray-900"></p>
              </div>
              <div class="sm:col-span-2">
                <label class="block text-sm font-medium text-gray-700"
                  >Email</label
                >
                <p id="email" class="mt-1 text-gray-900"></p>
              </div>
              <div class="sm:col-span-2">
                <label class="block text-sm font-medium text-gray-700"
                  >Phone Number</label
                >
                <input
                  type="text"
                  id="phone-input"
                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                />
              </div>
              <div class="sm:col-span-2">
                <button
                  id="update-phone-btn"
                  class="flex w-full justify-center rounded-md border border-transparent bg-indigo-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-indigo-700"
                >
                  Update Phone Number
                </button>
              </div>
              <div
                id="update-success"
                class="sm:col-span-2 text-sm text-green-600 hidden"
              ></div>
              <div
                id="update-error"
                class="sm:col-span-2 text-sm text-red-600"
              ></div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script>
      const API_BASE_URL = "http://localhost:5188";
      const logoutBtn = document.getElementById("logout-btn");
      const phoneInput = document.getElementById("phone-input");
      const updateBtn = document.getElementById("update-phone-btn");
      const updateError = document.getElementById("update-error");
      const updateSuccess = document.getElementById("update-success");

      async function loadProfile() {
        try {
          const res = await fetch(`${API_BASE_URL}/api/Account/profile`, {
            credentials: "include",
          });
          const data = await res.json();

          document.getElementById("first-name").textContent = data.firstName;
          document.getElementById("last-name").textContent = data.lastName;
          document.getElementById("email").textContent = data.email;
          phoneInput.value = data.phoneNo;
        } catch (err) {
          console.error("Failed to load profile", err);
        }
      }

      async function apiCall(url, method, body) {
        const res = await fetch(API_BASE_URL + url, {
          method,
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify(body),
        });

        if (!res.ok) throw new Error("Request failed");

        const contentType = res.headers.get("content-type");
        if (contentType && contentType.includes("application/json")) {
          return await res.json();
        } else {
          return await res.text();
        }
      }

      async function updatePhone(event) {
        event.preventDefault();
        const newPhoneNo = phoneInput.value;

        try {
          await apiCall("/api/Account/phone", "PUT", { newPhoneNo });
          updateSuccess.textContent = "Phone number updated successfully.";
          updateSuccess.classList.remove("hidden");
          updateError.textContent = "";
          setTimeout(() => {
            updateSuccess.classList.add("hidden");
          }, 3000);
        } catch (err) {
          updateError.textContent = "Failed to update phone number.";
          updateSuccess.classList.add("hidden");
        }
      }

      async function showAdminLinkIfAdmin() {
        try {
          const user = await apiCall("/api/Account/role", "GET");
          if (user.role === "System Admin") {
            document.getElementById("admin-link").classList.remove("hidden");
          }
        } catch (error) {
          console.error("Failed to fetch user info", error);
        }
      }

      async function handleLogout() {
        try {
          await fetch(`${API_BASE_URL}/api/Auth/logout`, {
            method: "POST",
            credentials: "include",
          });
        } finally {
          window.location.href = "login.html";
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        loadProfile();
        updateBtn.addEventListener("click", updatePhone);
        logoutBtn.addEventListener("click", handleLogout);
        showAdminLinkIfAdmin();
      });
    </script>
  </body>
</html>
